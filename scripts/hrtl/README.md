# HRTL Preprocessing Pipeline

This directory contains scripts for preparing HRTL (Healthy & Ready to Learn) data for the NE25 pipeline integration.

## Overview

HRTL is a school readiness assessment framework for children ages 3-5. The preprocessing pipeline:

1. **Phase 1:** Extract items and prepare domain datasets
2. **Phase 2:** Fit Rasch (1PL) IRT models to each domain
3. **Phase 3:** Impute missing item responses using fitted models
4. **Phase 4:** Apply item-level CAHMI thresholds for domain classification

## Scripts

### Phase 2: Rasch Model Fitting

These scripts fit Rasch (1PL graded) IRT models to each HRTL domain:

- **`phase2_rasch_step1.R`** - Extract domain items, verify coding, check age correlations
  - Input: `ne25_transformed` table from database
  - Output: `hrtl_domain_datasets.rds` (item lists and CAHMI mappings)
  - Also creates domain-specific item response tables with age/eligibility filters

- **`phase2_rasch_step2.R`** - Fit Rasch models to each domain
  - Input: Domain item responses from Phase 1
  - Output: `hrtl_rasch_models.rds` (fitted mirt objects)
  - Method: 1PL graded response models via `mirt()` package
  - Uses all `meets_inclusion=TRUE` records (all ages) for better parameter estimates

- **`phase2_fit_rasch_models.R`** - Orchestration script for Phase 2
  - Runs both step1 and step2 in sequence
  - Execute: `source("scripts/hrtl/phase2_fit_rasch_models.R")`

### Phase 3: Imputation

Scripts to impute missing item responses using fitted IRT models:

- **`hrtl_imputeMissing_allages.R`** - Main imputation script
  - Uses `mirt::imputeMissing()` with Theta parameter from EAP estimation
  - Applies to full dataset (all ages, all 5 domains)
  - Input: `hrtl_domain_datasets.rds`, `hrtl_rasch_models.rds`
  - Output: `scripts/temp/hrtl_data_imputed_allages.rds`
  - Execute: `source("scripts/hrtl/hrtl_imputeMissing_allages.R")`

- **`hrtl_mice_imputation.R`** - Alternative MICE-based imputation (experimental)
  - Not currently used; retained for reference

### Motor Development Augmentation (Experimental)

Scripts for attempting to improve Motor Development calibrations via NSCH augmentation:

- **`hrtl_prepare_augmented_dataset.R`** - Combine NE25 + NSCH 2022 data
  - Prepares augmented dataset for Motor Development calibration
  - Note: Augmentation did NOT improve results; simpler all-ages imputation used instead

- **`hrtl_augment_motor_only.R`** - Fit Rasch model on combined Motor data
  - Output: `scripts/temp/hrtl_rasch_motor_augmented.rds`
  - Not used in final pipeline (worse results than all-ages imputation)

- **`hrtl_imputeMissing_hybrid.R`** - Use augmented Motor model + NE25-only other domains
  - Attempted compromise approach
  - Result: Made HRTL scores worse; abandoned in favor of all-ages imputation

## Data Files

### Reference Data (in scripts/temp/)

Generated by preprocessing pipeline:

- **`hrtl_domain_datasets.rds`** - Domain item mappings
  - Structure: List of 5 domains (Early Learning, Health, Motor, Self-Regulation, Social-Emotional)
  - Each contains: data (item responses), variables (NE25 names), cahmi_codes (CAHMI equivalents)

- **`hrtl_rasch_models.rds`** - Fitted Rasch models
  - Five mirt objects (one per domain)
  - Used for EAP scoring and imputation
  - Trained on all `meets_inclusion=TRUE` records (all ages)

- **`hrtl_conversion_tables.rds`** - CAHMI age-specific thresholds
  - Source: HRTL-2022-Scoring-Thresholds.xlsx
  - Contains `on_track` and `emerging` cutoff values for each item by age (3, 4, 5)

- **`hrtl_data_imputed_allages.rds`** - Imputed item data
  - All 5 domains, all ages, all children in dataset
  - Missing values filled via `mirt::imputeMissing()` with Theta parameter
  - Input for pipeline Step 7.7

### Model Data (Not currently used)

- **`hrtl_rasch_motor_augmented.rds`** - Motor model fit on NE25 + NSCH combined data
  - Experimental; not used in final pipeline due to worse results

## Execution Flow

### Setup (One-time)

```bash
# Fit Rasch models to all domains
source("scripts/hrtl/phase2_fit_rasch_models.R")

# Impute missing values
source("scripts/hrtl/hrtl_imputeMissing_allages.R")
```

### Pipeline Integration (Automatic)

Once reference data exists, the NE25 pipeline automatically executes:

- **Step 7.7:** HRTL scoring using item-level CAHMI thresholds
- Loads imputed data from `scripts/temp/hrtl_data_imputed_allages.rds`
- Applies thresholds to classify domains for ages 3-5
- Saves results to `ne25_hrtl_domain_scores` and `ne25_hrtl_overall` tables

## Known Limitations

### Motor Development Excluded (Issue #15)

- **Problem:** 93% missing data for 3 of 4 Motor items (DrawFace, DrawPerson, BounceBall)
- **Cause:** NE25 survey design uses age-routing; Motor items only asked to select age groups
- **Solution:** Motor Development excluded from scoring; overall HRTL marked as NA
- **Impact:** Domain scores available for 4 domains only (Early Learning, Health, Self-Regulation, Social-Emotional)

### Age Filtering Impact

- Items are age-routed; some items unavailable for target ages 3-5
- Imputation on full dataset (all ages) provides better parameter estimates
- Filtering to 3-5 years happens AFTER imputation

## Technical Details

### Rasch Model Specifications

- **Type:** 1PL Graded Response Model (Rasch model with equal slopes)
- **Estimation:** Maximum likelihood via `mirt::mirt(itemtype='graded', constrain=...)`
- **Sample:** All `meets_inclusion=TRUE` records (not just 3-5 year-olds)
- **Rationale:** Larger sample size provides more stable parameter estimates

### Imputation Method

- **Function:** `mirt::imputeMissing()` with Theta parameter
- **Theta Estimation:** EAP (Empirical Bayes) via `mirt::fscores(method='EAP')`
- **Result:** Model-based imputation using item response patterns and child ability estimates
- **Validation:** All missing values successfully imputed to integer 0-4 range

## Files in R/hrtl/ (Production Scoring)

These are the production HRTL scoring functions (not preprocessing):

- **`score_hrtl.R`** - Pipeline wrapper function (Step 7.7)
- **`score_hrtl_itemlevel.R`** - Core item-level threshold scoring logic

## References

- [PIPELINE_STEPS.md - Step 7.7](../../docs/architecture/PIPELINE_STEPS.md#77-hrtl-scoring-item-level-thresholds)
- [GitHub Issue #15](https://github.com/anthropics/kidsights/issues/15) - Motor Development data quality
- [GitHub Issue #9](https://github.com/anthropics/kidsights/issues/9) - HRTL integration design

---

**Last Updated:** December 2025
