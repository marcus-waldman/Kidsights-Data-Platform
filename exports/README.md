# Data Exports Directory

This folder contains exported data files from the Kidsights Data Platform for analysis in external statistical software.

---

## Purpose

This directory serves as the default location for data exports generated by:
- Example scripts (e.g., `example-scripts/export_ne25_to_stata_spss.R`)
- Manual data exports from DuckDB
- Automated export pipelines

**⚠️ Important:** This folder is gitignored. Files in this directory are **never committed to version control** to protect participant privacy and confidentiality.

---

## Typical Contents

### NE25 Data Exports

Generated by `example-scripts/export_ne25_to_stata_spss.R`:

| File | Format | Description | Records | Variables |
|------|--------|-------------|---------|-----------|
| `ne25_data_dictionary.csv` | CSV | Complete variable documentation with labels and metadata | 471 | 14 columns |
| `ne25_raw.sav` | SPSS | Raw REDCap data with embedded labels | 4,962 | 6 |
| `ne25_raw.rds` | R Native | Raw REDCap data (preserves all R attributes) | 4,962 | 6 |
| `ne25_transformed.sav` | SPSS | Derived variables with labels (shortened names) | 4,962 | 641 |
| `ne25_transformed.rds` | R Native | Derived variables (original variable names) | 4,962 | 641 |

### ACS/NHIS/NSCH Exports

Additional exports from other pipelines may appear here depending on your workflow.

---

## File Formats

### SPSS (.sav)
- **Best for:** SPSS, Stata (via `import spss`), SAS users
- **Features:** Variable labels and value labels embedded
- **Limitations:** 64-character variable name limit (auto-shortened)
- **Load in SPSS:** `GET FILE='ne25_transformed.sav'.`
- **Load in Stata:** `import spss using "ne25_transformed.sav", clear`
- **Load in R:** `haven::read_sav("ne25_transformed.sav")`

### R Native (.rds)
- **Best for:** R users
- **Features:** Preserves all R attributes, original variable names, exact data types
- **No limitations:** Variable names, factors, dates, haven labels all preserved
- **Load in R:** `data <- readRDS("ne25_transformed.rds")`

### CSV (.csv)
- **Best for:** Universal compatibility, Excel, text editors
- **Features:** Human-readable, works with any software
- **Limitations:** No embedded labels or metadata (use data dictionary separately)
- **Load in R:** `data <- read.csv("ne25_data_dictionary.csv")`
- **Load in Python:** `df = pd.read_csv("ne25_data_dictionary.csv")`

---

## Data Dictionary

The `ne25_data_dictionary.csv` file contains comprehensive documentation:

**14 metadata columns:**
- `field_name` - Variable name in database
- `form_name` - REDCap form/instrument name
- `field_type` - Variable type (text, radio, checkbox, etc.)
- `field_label` - Full variable label/question text
- `select_choices_or_calculations` - Value mappings for categorical variables (REDCap format)
- `field_note` - Additional notes for data collectors
- `text_validation_*` - Data validation rules (min, max, type)
- `branching_logic` - Skip patterns and display conditions
- `required_field` - Whether field is mandatory
- `field_annotation` - Custom metadata and tags

**Usage:**
- Open in Excel for human-readable reference
- Import into statistical software for programmatic label lookup
- Use alongside SPSS/R data files to understand variable meanings

---

## Best Practices

### Security and Privacy

1. **Never commit exports to git** (already gitignored)
2. **Secure file sharing:** Use encrypted channels for sensitive data
3. **Local storage only:** Keep exports on secure, encrypted drives
4. **Delete when done:** Remove exports after analysis completion

### File Management

1. **Version naming:** Add date suffixes for tracking (e.g., `ne25_transformed_2025-10-27.rds`)
2. **Documentation:** Keep data dictionary with data files
3. **Backup strategy:** Regenerate from database rather than backing up exports
4. **Clean up regularly:** Remove old exports to save disk space

### Analysis Workflow

1. **Start with data dictionary** - Review variable definitions before analysis
2. **Check labels** - Verify variable and value labels loaded correctly
3. **Validate counts** - Confirm record counts match expectations
4. **Document transformations** - Note any additional data cleaning in analysis scripts

---

## Generating New Exports

### Interactive Export (Recommended)
```r
# GUI-guided export with automatic package installation
source("example-scripts/export_ne25_to_stata_spss.R")
```

### Programmatic Export
```r
# Load required packages
library(duckdb)
library(DBI)
library(haven)

# Connect to database
conn <- dbConnect(duckdb(), "data/duckdb/kidsights_local.duckdb", read_only = TRUE)

# Query data
data <- dbGetQuery(conn, "SELECT * FROM ne25_transformed")

# Export to SPSS
write_sav(data, "exports/my_export.sav")

# Export to R native
saveRDS(data, "exports/my_export.rds")

# Disconnect
dbDisconnect(conn, shutdown = TRUE)
```

---

## Troubleshooting

### "Variable name too long" errors
- SPSS has 64-character limit, Stata has 32-character limit
- Use the example export script - it auto-shortens names
- Or use RDS format which has no restrictions

### Labels not loading
- Ensure you're using `haven::read_sav()` in R (not `foreign::read.spss()`)
- Check that data dictionary was included with export
- Verify label extraction worked (check console output during export)

### "File not found" errors
- Check that database exists: `data/duckdb/kidsights_local.duckdb`
- Run NE25 pipeline first: `"C:\Program Files\R\R-4.5.1\bin\R.exe" --slave --no-restore --file=run_ne25_pipeline.R`

---

## Related Documentation

- **Export Script Documentation:** [example-scripts/README.md](../example-scripts/README.md)
- **Database Schema:** [docs/architecture/PIPELINE_OVERVIEW.md](../docs/architecture/PIPELINE_OVERVIEW.md)
- **Variable Reference:** [docs/guides/DERIVED_VARIABLES_SYSTEM.md](../docs/guides/DERIVED_VARIABLES_SYSTEM.md)

---

**Last Updated:** October 2025
